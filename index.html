<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8"></meta>
	<title>Game</title>
</head>

<style type="text/css">

body {
	background-color: black;
}

canvas {
	position: absolute;
	background-color: white;
	left: 50%;
	margin-left: -320px;
}

</style>

<body>

	<canvas  width=640 height=480 id="view"></canvas>

	<script src="js/game_state.js"></script>
	<script src="js/controller.js"></script>
	<script src="js/sprite_factory.js"></script>
	<script src="js/sprite.js"></script>
	<script src="js/levels.js"></script>

	<!-- Objects -->
	<script src="js/objects/game_object.js"></script>
	<script src="js/objects/block.js"></script>
	<script src="js/objects/guy.js"></script>
	<script src="js/objects/square.js"></script>

	<!-- Behaviors -->
	<script src="js/behaviors/physical.js"></script>
	<script src="js/behaviors/moving.js"></script>
	<script src="js/behaviors/solid.js"></script>
	<script src="js/behaviors/platform.js"></script>
	<script src="js/behaviors/renderable.js"></script>
	<script src="js/behaviors/face_direction.js"></script>

	<script>
	var canvas = document.getElementById("view");
	var ctx = canvas.getContext("2d");

	var controlled; // Points to currently controlled object
	var state = createGameState();

	state.parseLevel(Levels.level1);


	controlled = state.filter("Moving")[0];
	/*// Här plockar jag bara ut en slumpad rörbar gubbe och börjar styra...
	*/

	controller = createController();
	state.addObject(controller);

	//=====================
	// Handle mouse presses
	//=====================
	document.body.onmousedown = function(event) {
		var obj;
		var moving = state.filter("Moving");

		// If a moving object is clicked, start controlling it
		for (var i = 0; i < moving.length; i++) {
			obj = moving[i];
			if (obj.overlapsPoint(event.offsetX, event.offsetY)) {
				controlled.hAcceleration = 0;
				controlled.hSpeed = 0;
				controlled = obj;
				return;
			}
		}

		// If no moving object was clicked, a block is created
		block = createBlock();
		block.x = 16 * Math.round(event.offsetX / 16);
		block.y = 16 * Math.round(event.offsetY /16);
		state.addObject(block);
	};

	//===================
	// The main game loop
	//===================
	function tick() {
		window.requestAnimationFrame(tick);
		var renderList = state.filter("Renderable");
		ctx.clearRect(0, 0, canvas.width, canvas.height);

		// Game controls
		if (controller.down("left")) {
			controlled.hAcceleration = -0.5;
		} else if (controller.down("right")) {
			controlled.hAcceleration = 0.5;
		} else {
			controlled.hAcceleration = -controlled.hSpeed / 5;
		}

		if (controller.pressed("up")) {
			controlled.jump();
		}

		if (controller.released("up")) {
			if (controlled.vSpeed < 0) {
				controlled.vSpeed /= 2;
			}
		}

		// Perform update functions for all in-game objects
		for (var i = 0; i < state.objects.length; i++) {
			state.objects[i].tick(state);
		}

		// Render in-game objects
		for (var i = 0; i < renderList.length; i++) {
			renderList[i].render(ctx);
		}
	}

	// Start the game loop
	window.requestAnimationFrame(tick);

	</script>
</body>
