<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"></meta>
    <title>Game</title>
</head>

<body>

    <canvas id="view"></canvas>

    <script src="js/game_state.js"></script>
    <script src="js/game_object.js"></script>
    <script src="js/controller.js"></script>
    <script src="js/animation.js"></script>
    <script src="js/block.js"></script>
    <script src="js/guy.js"></script>

    <!-- Behaviors -->
    <script src="js/behaviors/moving.js"></script>
    <script src="js/behaviors/solid.js"></script>
    <script src="js/behaviors/platform.js"></script>
    <script src="js/behaviors/renderable.js"></script>
    <script src="js/behaviors/face_direction.js"></script>

    <script>

    var canvas = document.getElementById("view");
    var ctx = canvas.getContext("2d");

    window.requestAnimationFrame(tick);

    var gameState = createGameState();

    // Add game objects
    var sprite, block, controller;

    for (var i = 0; i < 10; i++) {
        block = createBlock(ctx);
        block.x = i * 16;
        block.y = 128;
        gameState.addObject(block);
    }

    guy = createGuy(ctx);
    guy.x = 32;
    guy.y = 32;
    gameState.addObject(guy);

    controller = createController();
    gameState.addObject(controller);

    document.body.onmousedown = function(event) {
        block = createBlock(ctx);
        block.x = 16 * Math.round((event.clientX - 8) / 16);
        block.y = 16 * Math.round((event.clientY - 8) / 16);
        gameState.addObject(block);
    };

    function tick() {
        window.requestAnimationFrame(tick);
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        for (var i = 0; i < gameState.objects.length; i++) {
            gameState.objects[i].tickStart(gameState);
        }


        if (controller.down("left")) {
            guy.hAcceleration = -0.5;
        } else if (controller.down("right")) {
            guy.hAcceleration = 0.5;
        } else {
            guy.hAcceleration = -guy.hSpeed / 5;
        }

        if (controller.pressed("up")) {
            guy.jump();
        }

        if (controller.released("up")) {
            if (guy.vSpeed < 0) {
                guy.vSpeed /= 2;
            }
        }

        for (var i = 0; i < gameState.objects.length; i++) {
            gameState.objects[i].tickEnd(gameState); //@TODO: remove the 'solidObject' argument
        }

    };

    </script>
</body>